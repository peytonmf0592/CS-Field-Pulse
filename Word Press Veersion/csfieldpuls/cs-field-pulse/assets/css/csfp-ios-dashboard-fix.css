/* CS Field Pulse - iOS Safari Dashboard Fix */
/* Fixes KPI row, toolbar clipping, and scroll issues */
/* Desktop remains unchanged - all fixes are mobile-only */

/* ========================================
   CSS Variables
   ======================================== */
:root {
    --z-header: 1000;
    --z-popover: 9999;
    --z-modal: 10000;
    --gutter: 16px;
}

/* ========================================
   Global Setup
   ======================================== */
@supports (height: 100dvh) {
    body,
    #app,
    .csfp-container {
        min-height: 100dvh;
    }
}

html {
    -webkit-text-size-adjust: 100%;
}

/* Prevent iOS zoom on inputs */
input,
select,
textarea {
    font-size: 16px !important;
}

/* ========================================
   Mobile-Only Fixes (â‰¤640px)
   ======================================== */
@media (max-width: 640px) {
    /* Body safe areas */
    body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* Container gutters */
    .csfp-container {
        padding-left: var(--gutter);
        padding-right: var(--gutter);
        overflow-x: hidden;
        box-sizing: border-box;
    }
    
    /* ========================================
       Header + Search - Clean Wrapping
       ======================================== */
    .csfp-navigation {
        position: sticky;
        top: calc(8px + env(safe-area-inset-top));
        z-index: var(--z-header);
        background: rgba(26, 26, 26, 0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        margin: 0 calc(-1 * var(--gutter)) 1rem calc(-1 * var(--gutter));
        padding: 1rem var(--gutter);
    }
    
    /* Search row flexible layout */
    #csfp-quick-search-container .csfp-quick-search {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .csfp-quick-search-input {
        flex: 1 1 260px;
        min-width: 0;
    }
    
    /* ========================================
       ACTION TOOLBAR FIX - Grid Layout
       ======================================== */
    /* Fix the filter/action row to use grid */
    .csfp-glass.csfp-card[style*="display: flex"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
        padding: 1rem !important;
    }
    
    /* Filter group takes full width */
    .csfp-filter-group {
        width: 100% !important;
        flex-direction: column !important;
        gap: 0.75rem !important;
    }
    
    /* View toggle and selectors stack */
    .csfp-view-toggle,
    #rfm-selector,
    #market-selector {
        width: 100%;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0.75rem;
    }
    
    .csfp-filter-label {
        min-width: 60px;
    }
    
    .csfp-filter-select {
        flex: 1;
        min-width: 0;
    }
    
    /* Action buttons grid - 2 columns on mobile, 3 if space allows */
    .csfp-glass.csfp-card > div[style*="display: flex"]:last-child {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
        gap: 12px !important;
        width: 100% !important;
    }
    
    /* Ensure all buttons are visible */
    #csfp-export-visits,
    #quick-visit-btn,
    .csfp-btn {
        width: 100% !important;
        min-width: 0 !important;
        min-height: 44px;
        white-space: normal;
        padding: 0.75rem 0.5rem;
    }
    
    /* Add Start Market Tour button if it exists */
    #start-market-tour-btn {
        width: 100% !important;
        min-width: 0 !important;
    }
    
    /* ========================================
       KPI GRID FIX - 2-up Layout
       ======================================== */
    .csfp-stats-grid {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 12px !important;
        margin: 1rem 0;
    }
    
    .csfp-stat-card {
        min-width: 0 !important;
        padding: 1rem 0.75rem;
    }
    
    .csfp-stat-number {
        font-size: clamp(1.5rem, 5vw, 2rem);
        word-break: break-word;
    }
    
    .csfp-stat-label {
        font-size: clamp(0.75rem, 2.5vw, 0.875rem);
        word-break: break-word;
    }
    
    /* Very narrow screens (iPhone SE) - single column */
    @media (max-width: 380px) {
        .csfp-stats-grid {
            grid-template-columns: 1fr !important;
        }
    }
    
    /* ========================================
       Panels/Cards - No Clipping
       ======================================== */
    .csfp-panel,
    .csfp-card,
    .csfp-glass {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: visible;
        margin-left: 0;
        margin-right: 0;
    }
    
    /* Card borders instead of outline rings */
    .csfp-card {
        border: 2px solid var(--csfp-green, #00ff88);
        border-radius: 14px;
        outline: none;
    }
    
    /* ========================================
       Recent Activity - Safe Bottom Padding
       ======================================== */
    .csfp-recent-activity-compact,
    #recent-activity-list {
        padding-bottom: calc(24px + env(safe-area-inset-bottom));
    }
    
    .csfp-activity-pagination {
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    
    #load-more-activity {
        width: 100%;
        margin-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    
    /* ========================================
       Charts + Map - Respect Gutters
       ======================================== */
    .csfp-chart-container-compact,
    .csfp-map-container-compact {
        width: 100%;
        max-width: 100%;
        margin-left: auto;
        margin-right: auto;
        box-sizing: border-box;
    }
    
    #csfp-map {
        height: 300px;
        width: 100%;
        border-radius: 8px;
    }
    
    .csfp-chart-wrapper-compact canvas {
        max-width: 100% !important;
        height: auto !important;
    }
    
    /* Stack dashboard layout on mobile */
    .csfp-dashboard-compact {
        display: block !important;
    }
    
    .csfp-dashboard-main,
    .csfp-dashboard-sidebar {
        width: 100% !important;
        margin: 0 !important;
    }
    
    .csfp-charts-row-compact {
        flex-direction: column;
        gap: 1rem;
    }
    
    /* ========================================
       Kill Horizontal Overflow Culprits
       ======================================== */
    .bg-bleed,
    .csfp-full-bleed {
        max-width: 100%;
    }
    
    /* Remove transforms that cause iOS bugs */
    @media (max-width: 640px) {
        .csfp-container *:not(.csfp-modal-content) {
            transform: none !important;
        }
    }
}

/* ========================================
   SCROLL FIX - Prevent Sticky Scrolling
   ======================================== */
@media (max-width: 640px) {
    /* Remove nested scroll containers */
    .csfp-dashboard-compact,
    .csfp-dashboard-main,
    .csfp-dashboard-sidebar {
        overflow: visible !important;
        height: auto !important;
    }
    
    /* Activity list uses iOS momentum scrolling */
    .csfp-activity-scroll {
        max-height: 400px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
    }
    
    /* Map guard overlay for gesture control */
    .csfp-map-container-compact {
        position: relative;
    }
    
    .csfp-map-guard {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        border-radius: 8px;
        z-index: 2;
        cursor: pointer;
    }
    
    .csfp-map-guard.hidden {
        display: none;
    }
    
    #csfp-map {
        pointer-events: none;
    }
    
    #csfp-map.interactive {
        pointer-events: auto;
    }
}

/* ========================================
   POPOVERS - Above Everything
   ======================================== */
.csfp-popover,
.csfp-search-popover,
.csfp-search-portal {
    position: fixed !important;
    z-index: var(--z-popover) !important;
    max-height: 60vh;
    overflow: auto;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    -webkit-overflow-scrolling: touch;
}

/* Ensure body-rendered popovers stay on top */
body > .csfp-search-portal,
body > .csfp-popover {
    z-index: var(--z-popover) !important;
}

/* ========================================
   Touch Target Optimization
   ======================================== */
@media (max-width: 640px) {
    button,
    .csfp-btn,
    .csfp-toggle-btn,
    .csfp-filter-select,
    select,
    input[type="button"],
    input[type="submit"] {
        min-height: 44px;
        touch-action: manipulation;
    }
}

/* ========================================
   Prevent Horizontal Scroll
   ======================================== */
@media (max-width: 640px) {
    html,
    body {
        overflow-x: hidden;
        max-width: 100vw;
    }
    
    .csfp-container {
        max-width: 100vw;
        overflow-x: hidden;
    }
}